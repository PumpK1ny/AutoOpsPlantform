<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eros - æ•°æ®åˆ†æç»“æœå±•ç¤º</title>
    <link rel="shortcut icon" type="image/png" href="{{ url_for('serve_static', path='icon.png') }}">
    <link rel="icon" type="image/png" href="{{ url_for('serve_static', path='icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('serve_static', path='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js"></script>
    <style>
        .nav-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            border: 1px solid transparent;
            background: transparent;
        }

        .nav-item:hover {
            background: var(--bg-glass-hover);
            border-color: var(--border-glow);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-glow);
        }

        .nav-item.active .nav-name {
            color: white;
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        .nav-icon {
            font-size: 1.3rem;
            margin-right: 12px;
            transition: transform var(--transition-fast);
        }

        .nav-name {
            flex: 1;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color var(--transition-normal);
        }

        .section-divider {
            height: 1px;
            background: var(--border-color);
            margin: 16px 0;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .status-indicator.online {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .status-indicator.offline {
            background: var(--danger);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .system-status-grid {
            display: grid;
            gap: 20px;
        }

        .service-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            transition: all var(--transition-normal);
        }

        .service-card:hover {
            border-color: var(--border-glow);
            box-shadow: var(--shadow-sm);
        }

        .service-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .service-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .service-card-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .status-tags {
            display: flex;
            gap: 8px;
        }

        .status-tag {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-tag.running {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-tag.stopped {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .status-tag.enabled {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
            border: 1px solid var(--info);
        }

        .status-tag.disabled {
            background: rgba(156, 163, 175, 0.2);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .service-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .btn-action {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }

        .btn-action:hover {
            border-color: var(--primary-color);
            color: var(--text-primary);
        }

        .btn-action.primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-action.primary:hover {
            background: var(--primary-hover);
        }

        .refresh-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--bg-glass);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }

        .refresh-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .last-update {
            color: var(--success);
            font-weight: 500;
        }

        .task-grid {
            display: grid;
            gap: 16px;
        }

        .task-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            transition: all var(--transition-normal);
        }

        .task-card:hover {
            border-color: var(--border-glow);
        }

        .task-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .task-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .task-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .task-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .task-schedule {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-accent);
            background: var(--bg-tertiary);
            padding: 4px 12px;
            border-radius: var(--radius-sm);
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .btn-task {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }

        .btn-task:hover {
            border-color: var(--primary-color);
            color: var(--text-primary);
        }

        .btn-task.run {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .btn-task.run:hover {
            background: #059669;
        }

        .btn-task.toggle {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }

        .btn-task.toggle:hover {
            background: #d97706;
        }

        .task-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .task-empty .icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 16px 20px;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
        }

        .btn-modal {
            padding: 8px 14px;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }

        .btn-modal:hover {
            border-color: var(--primary-color);
            color: var(--text-primary);
        }

        .btn-modal.primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-modal.primary:hover {
            background: var(--primary-hover);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all var(--transition-fast);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-select {
            cursor: pointer;
        }

        .password-input-group {
            display: flex;
            align-items: center;
        }

        .password-input-group .form-input {
            border-radius: var(--radius-md) 0 0 var(--radius-md);
            border-right: none;
            flex: 1;
        }

        .password-toggle {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle:hover {
            background: var(--bg-glass-hover);
        }

        .log-viewer {
            background: #1e1e1e;
            border-radius: var(--radius-md);
            padding: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #d4d4d4;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-line {
            padding: 2px 0;
        }

        .log-line.error { color: #f48771; }
        .log-line.warning { color: #dcdcaa; }
        .log-line.success { color: #4ec9b0; }
        .log-line.info { color: #4fc1ff; }

        .log-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .log-modal-fullscreen {
            max-width: 90vw;
            max-height: 90vh;
            width: auto;
        }

        .log-modal-fullscreen .modal {
            width: 95vw;
            max-width: 1400px;
        }

        /* è¿è¡Œä¸­ä»»åŠ¡æ ·å¼ */
        .running-task-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 16px;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .running-task-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--success);
        }

        .running-task-card:hover {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }

        .running-task-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .running-task-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .running-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--success);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--success);
            font-weight: 600;
        }

        .running-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .running-task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .running-task-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .running-task-info .label {
            color: var(--text-muted);
        }

        .running-task-info .value {
            color: var(--text-accent);
            font-weight: 500;
        }

        .history-task-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            transition: all var(--transition-normal);
        }

        .history-task-card:hover {
            border-color: var(--border-glow);
        }

        .history-task-card.completed {
            border-left: 4px solid var(--success);
        }

        .history-task-card.failed {
            border-left: 4px solid var(--danger);
        }

        .history-task-card.timeout {
            border-left: 4px solid var(--warning);
        }

        .history-task-card.error {
            border-left: 4px solid var(--danger);
        }

        .history-task-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .history-task-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .history-task-status {
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .history-task-status.completed {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .history-task-status.failed,
        .history-task-status.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .history-task-status.timeout {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .history-task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .no-tasks {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .no-tasks .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .task-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 8px;
        }

        .task-type-badge.manual {
            background: rgba(59, 130, 246, 0.15);
            color: var(--info);
        }

        .task-type-badge.scheduled {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1><img src="{{ url_for('serve_static', path='icon.png') }}" alt="Eros" style="width: 28px; height: 28px; vertical-align: middle; margin-right: 8px; border-radius: 4px;">Eros</h1>
                <p class="subtitle">æ™ºèƒ½åŸºé‡‘ç›‘æ§ç³»ç»Ÿ</p>
            </div>
            
            <nav class="folder-nav">
                <h3>ğŸ“ æ•°æ®æŸ¥çœ‹</h3>
                <ul id="folderList">
                    {% for folder in folders %}
                    <li class="nav-item" data-folder="{{ folder.name }}" onclick="showDataFolder('{{ folder.name }}')">
                        <span class="nav-icon">ğŸ“‚</span>
                        <span class="nav-name">{{ folder.display_name }}</span>
                        <span class="folder-count" id="count-{{ folder.name }}"></span>
                    </li>
                    {% endfor %}
                </ul>

                <div class="section-divider"></div>

                <h3>âš™ï¸ ç³»ç»Ÿç®¡ç†</h3>
                <ul>
                    <li class="nav-item" onclick="showRunningTasks()">
                        <span class="nav-icon">â–¶ï¸</span>
                        <span class="nav-name">è¿è¡Œä¸­ä»»åŠ¡</span>
                        <span class="status-indicator online" id="runningTaskIndicator" style="display: none;"></span>
                    </li>
                    <li class="nav-item" onclick="showTaskManager()">
                        <span class="nav-icon">â°</span>
                        <span class="nav-name">ä»»åŠ¡è°ƒåº¦</span>
                    </li>
                    <li class="nav-item" onclick="showSystemStatus()">
                        <span class="nav-icon">ğŸ–¥ï¸</span>
                        <span class="nav-name">ç³»ç»ŸçŠ¶æ€</span>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <p>ğŸ“… {{ now.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</p>
            </div>
        </aside>

        <main class="main-content">
            <div class="content-panel" id="dataPanel">
                <div class="panel-header">
                    <h2 id="currentFolderName">ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹</h2>
                    <span class="file-count" id="fileCount">å…± 0 ä¸ªæ–‡ä»¶</span>
                </div>
                <div class="file-list" id="fileList">
                    <div class="empty-state">
                        <p>ğŸ‘ˆ è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹æŸ¥çœ‹æ•°æ®</p>
                    </div>
                </div>
            </div>

            <div class="content-panel" id="contentPanel">
                <div class="panel-header">
                    <h2 id="currentFileName">ğŸ“„ é€‰æ‹©æ–‡ä»¶</h2>
                    <div class="header-actions">
                        <button class="btn btn-fullscreen" onclick="toggleFullscreen()">ğŸ” å…¨å±</button>
                        <button class="btn btn-refresh" onclick="refreshCurrentFile()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                <div class="content-wrapper" id="contentWrapper">
                    <div class="content-viewer" id="contentViewer">
                        <div class="empty-state">
                            <p>ğŸ‘† è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶æŸ¥çœ‹è¯¦æƒ…</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-panel content-section" id="runningTasksPanel">
                <div class="panel-header">
                    <h2>â–¶ï¸ è¿è¡Œä¸­ä»»åŠ¡</h2>
                    <div class="header-actions">
                        <button class="btn btn-refresh" onclick="loadRunningTasks()">ğŸ”„ åˆ·æ–°</button>
                        <button class="btn" onclick="loadTaskHistory()">ğŸ“œ å†å²è®°å½•</button>
                    </div>
                </div>
                <div class="content-wrapper">
                    <div class="content-viewer">
                        <div class="refresh-bar">
                            <div class="refresh-info">
                                <span>ğŸ“Š</span>
                                <span id="runningTasksLastUpdate">æ­£åœ¨åŠ è½½...</span>
                            </div>
                            <span id="runningTasksCount" style="font-size: 0.85rem; color: var(--text-muted);"></span>
                        </div>
                        <div id="runningTasksContainer">
                            <div class="loading">æ­£åœ¨åŠ è½½è¿è¡Œä¸­ä»»åŠ¡...</div>
                        </div>
                        <div id="taskHistoryContainer" style="display: none; margin-top: 20px;">
                            <h3 style="margin-bottom: 16px; color: var(--text-primary);">ğŸ“œ æœ€è¿‘æ‰§è¡Œå†å²</h3>
                            <div id="taskHistoryList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-panel content-section" id="taskPanel">
                <div class="panel-header">
                    <h2>â° ä»»åŠ¡è°ƒåº¦ç®¡ç†</h2>
                    <button class="btn btn-refresh" onclick="loadTasks()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div class="content-wrapper">
                    <div class="content-viewer">
                        <div id="taskListContainer">
                            <div class="loading">æ­£åœ¨åŠ è½½ä»»åŠ¡...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-panel content-section" id="statusPanel">
                <div class="panel-header">
                    <h2>ğŸ–¥ï¸ ç³»ç»ŸçŠ¶æ€</h2>
                    <button class="btn btn-refresh" onclick="loadSystemStatus()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div class="content-wrapper">
                    <div class="content-viewer">
                        <div class="refresh-bar">
                            <div class="refresh-info">
                                <span>ğŸ“Š</span>
                                <span id="statusLastUpdate">æ­£åœ¨åŠ è½½...</span>
                            </div>
                        </div>
                        <div class="system-status-grid" id="servicesContainer">
                            <div class="loading">æ­£åœ¨åŠ è½½æœåŠ¡çŠ¶æ€...</div>
                        </div>
                        <div id="platformInfo" style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="passwordModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="passwordModalTitle">ğŸ” è¾“å…¥å¯†ç </h3>
                <button class="modal-close" onclick="closePasswordModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">æ“ä½œå¯†ç </label>
                    <div class="password-input-group">
                        <input type="password" class="form-input" id="passwordInput" placeholder="è¯·è¾“å…¥æ“ä½œå¯†ç ">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
                            <span id="passwordToggleIcon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal" onclick="closePasswordModal()">å–æ¶ˆ</button>
                <button class="btn-modal primary" id="passwordConfirmBtn" onclick="confirmPasswordAction()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3>âœï¸ ç¼–è¾‘ä»»åŠ¡</h3>
                <button class="modal-close" onclick="closeEditModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTaskId">
                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡åç§°</label>
                    <input type="text" class="form-input" id="editTaskName" placeholder="ä»»åŠ¡åç§°">
                </div>
                <div class="form-group">
                    <label class="form-label">æè¿°</label>
                    <textarea class="form-input form-textarea" id="editTaskDesc" placeholder="ä»»åŠ¡æè¿°"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">æ‰§è¡Œå‘½ä»¤</label>
                    <textarea class="form-input form-textarea" id="editTaskCommand" placeholder="æ‰§è¡Œçš„å‘½ä»¤"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">è°ƒåº¦ç±»å‹</label>
                    <select class="form-input form-select" id="editScheduleType">
                        <option value="daily">æ¯æ—¥</option>
                        <option value="interval">é—´éš”</option>
                        <option value="cron">Cron è¡¨è¾¾å¼</option>
                    </select>
                </div>
                <div class="form-group" id="scheduleTimeGroup">
                    <label class="form-label">æ‰§è¡Œæ—¶é—´ (æ¯æ—¥æ—¶å¡« HH:MM)</label>
                    <input type="text" class="form-input" id="editScheduleTime" placeholder="00:00">
                </div>
                <div class="form-group" id="scheduleMinutesGroup" style="display: none;">
                    <label class="form-label">é—´éš”åˆ†é’Ÿæ•°</label>
                    <input type="number" class="form-input" id="editScheduleMinutes" placeholder="60">
                </div>
                <div class="form-group">
                    <label class="form-label">è¶…æ—¶æ—¶é—´ (ç§’)</label>
                    <input type="number" class="form-input" id="editTaskTimeout" placeholder="300">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="btn-modal primary" onclick="saveTaskConfig()">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="logsModal">
        <div class="modal log-modal-fullscreen">
            <div class="modal-header">
                <h3 id="logsModalTitle">ğŸ“‹ ä»»åŠ¡æ—¥å¿—</h3>
                <button class="modal-close" onclick="closeLogsModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="log-viewer" id="taskLogsContent">æ­£åœ¨åŠ è½½æ—¥å¿—...</div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal" onclick="closeLogsModal()">å…³é—­</button>
                <button class="btn-modal primary" onclick="loadSchedulerLogs()">ğŸ”„ åˆ·æ–°</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('serve_static', path='js/app.js') }}"></script>
    <script>
        let currentPasswordAction = null;
        let currentTaskId = null;
        let currentSection = 'data';

        function toggleMobileMenu() {
            const btn = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            btn.classList.toggle('active');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            document.getElementById('mobileMenuBtn').classList.remove('active');
            document.getElementById('sidebar').classList.remove('mobile-open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        function showDataFolder(folderName) {
            currentSection = 'data';
            closeMobileMenu();
            stopRunningTasksAutoRefresh();

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-folder="${folderName}"]`)?.classList.add('active');

            document.querySelectorAll('.content-section').forEach(panel => panel.classList.remove('active'));
            document.getElementById('dataPanel').style.display = 'flex';
            document.getElementById('contentPanel').style.display = 'flex';
            document.getElementById('runningTasksPanel').classList.remove('active');

            selectFolder(folderName);
        }

        function showRunningTasks() {
            currentSection = 'running';
            closeMobileMenu();

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget?.classList.add('active');

            document.getElementById('dataPanel').style.display = 'none';
            document.getElementById('contentPanel').style.display = 'none';
            document.getElementById('taskPanel').classList.remove('active');
            document.getElementById('statusPanel').classList.remove('active');
            document.getElementById('runningTasksPanel').classList.add('active');

            loadRunningTasks();
            // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
            startRunningTasksAutoRefresh();
        }

        let runningTasksRefreshInterval = null;

        function startRunningTasksAutoRefresh() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (runningTasksRefreshInterval) {
                clearInterval(runningTasksRefreshInterval);
            }
            // æ¯ 5 ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
            runningTasksRefreshInterval = setInterval(() => {
                if (currentSection === 'running') {
                    loadRunningTasks(false); // false è¡¨ç¤ºä¸æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                }
            }, 5000);
        }

        function stopRunningTasksAutoRefresh() {
            if (runningTasksRefreshInterval) {
                clearInterval(runningTasksRefreshInterval);
                runningTasksRefreshInterval = null;
            }
        }

        async function loadRunningTasks(showLoading = true) {
            const container = document.getElementById('runningTasksContainer');
            const lastUpdate = document.getElementById('runningTasksLastUpdate');
            const countDisplay = document.getElementById('runningTasksCount');
            const indicator = document.getElementById('runningTaskIndicator');

            if (showLoading) {
                container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½è¿è¡Œä¸­ä»»åŠ¡...</div>';
            }

            try {
                const response = await fetch('/api/task-monitor/running');
                const data = await response.json();

                lastUpdate.textContent = `ä¸Šæ¬¡æ›´æ–°: ${data.timestamp || new Date().toLocaleString()}`;

                if (data.error) {
                    container.innerHTML = `<div class="no-tasks"><p class="icon">âš ï¸</p><p>${data.error}</p></div>`;
                    countDisplay.textContent = '';
                    indicator.style.display = 'none';
                    return;
                }

                const tasks = data.tasks || [];
                countDisplay.textContent = `å…± ${tasks.length} ä¸ªä»»åŠ¡è¿è¡Œä¸­`;

                // æ›´æ–°ä¾§è¾¹æ æŒ‡ç¤ºå™¨
                if (tasks.length > 0) {
                    indicator.style.display = 'inline-block';
                } else {
                    indicator.style.display = 'none';
                }

                if (tasks.length === 0) {
                    container.innerHTML = `
                        <div class="no-tasks">
                            <p class="icon">ğŸ˜´</p>
                            <p>å½“å‰æ²¡æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡</p>
                            <p style="font-size: 0.85rem; margin-top: 8px;">æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨ä¼‘æ¯ä¸­~</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                tasks.forEach(task => {
                    const typeBadge = task.task_type === 'manual' ?
                        '<span class="task-type-badge manual">æ‰‹åŠ¨</span>' :
                        '<span class="task-type-badge scheduled">å®šæ—¶</span>';

                    html += `
                        <div class="running-task-card">
                            <div class="running-task-header">
                                <div class="running-task-title">
                                    ${task.task_name}
                                    ${typeBadge}
                                </div>
                                <span class="running-indicator">è¿è¡Œä¸­</span>
                            </div>
                            <div class="running-task-meta">
                                <div class="running-task-info">
                                    <span class="label">ğŸ“‹ ä»»åŠ¡ID:</span>
                                    <span class="value">${task.task_id}</span>
                                </div>
                                <div class="running-task-info">
                                    <span class="label">ğŸ• å¼€å§‹æ—¶é—´:</span>
                                    <span class="value">${task.start_time}</span>
                                </div>
                                <div class="running-task-info">
                                    <span class="label">â±ï¸ è¿è¡Œæ—¶é•¿:</span>
                                    <span class="value">${task.duration}</span>
                                </div>
                                ${task.pid ? `
                                <div class="running-task-info">
                                    <span class="label">ğŸ”¢ è¿›ç¨‹ID:</span>
                                    <span class="value">${task.pid}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('Load running tasks error:', error);
                if (showLoading) {
                    container.innerHTML = `<div class="no-tasks"><p class="icon">âŒ</p><p>åŠ è½½å¤±è´¥: ${error.message}</p></div>`;
                }
                countDisplay.textContent = '';
            }
        }

        async function loadTaskHistory() {
            const container = document.getElementById('taskHistoryContainer');
            const listContainer = document.getElementById('taskHistoryList');

            // åˆ‡æ¢æ˜¾ç¤º/éšè—
            if (container.style.display === 'none') {
                container.style.display = 'block';
                listContainer.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å†å²è®°å½•...</div>';

                try {
                    const response = await fetch('/api/task-monitor/history?limit=20');
                    const data = await response.json();

                    if (data.error) {
                        listContainer.innerHTML = `<div class="no-tasks"><p>${data.error}</p></div>`;
                        return;
                    }

                    const history = data.history || [];

                    if (history.length === 0) {
                        listContainer.innerHTML = `
                            <div class="no-tasks">
                                <p class="icon">ğŸ“­</p>
                                <p>æš‚æ— æ‰§è¡Œå†å²</p>
                            </div>
                        `;
                        return;
                    }

                    let html = '';
                    history.forEach(task => {
                        const statusClass = task.status || 'unknown';
                        const statusText = {
                            'completed': 'âœ… æˆåŠŸ',
                            'failed': 'âŒ å¤±è´¥',
                            'timeout': 'â±ï¸ è¶…æ—¶',
                            'error': 'ğŸ’¥ é”™è¯¯',
                            'running': 'ğŸ”„ è¿è¡Œä¸­'
                        }[task.status] || task.status;

                        const typeBadge = task.task_type === 'manual' ?
                            '<span class="task-type-badge manual">æ‰‹åŠ¨</span>' :
                            '<span class="task-type-badge scheduled">å®šæ—¶</span>';

                        html += `
                            <div class="history-task-card ${statusClass}">
                                <div class="history-task-header">
                                    <div class="history-task-title">
                                        ${task.task_name}
                                        ${typeBadge}
                                    </div>
                                    <span class="history-task-status ${statusClass}">${statusText}</span>
                                </div>
                                <div class="history-task-meta">
                                    <span>ğŸ“‹ ${task.task_id}</span>
                                    <span>ğŸ• ${task.start_time || '-'}</span>
                                    <span>â±ï¸ ${task.duration || '-'}</span>
                                    ${task.end_time ? `<span>ğŸ ${task.end_time}</span>` : ''}
                                </div>
                                ${task.error ? `<div style="margin-top: 8px; color: var(--danger); font-size: 0.8rem;">âŒ ${task.error.substring(0, 100)}${task.error.length > 100 ? '...' : ''}</div>` : ''}
                            </div>
                        `;
                    });

                    listContainer.innerHTML = html;

                } catch (error) {
                    console.error('Load task history error:', error);
                    listContainer.innerHTML = `<div class="no-tasks"><p>åŠ è½½å¤±è´¥: ${error.message}</p></div>`;
                }
            } else {
                container.style.display = 'none';
            }
        }

        function showTaskManager() {
            currentSection = 'task';
            closeMobileMenu();
            stopRunningTasksAutoRefresh();

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget?.classList.add('active');

            document.getElementById('dataPanel').style.display = 'none';
            document.getElementById('contentPanel').style.display = 'none';
            document.getElementById('runningTasksPanel').classList.remove('active');
            document.getElementById('taskPanel').classList.add('active');
            document.getElementById('statusPanel').classList.remove('active');

            loadTasks();
        }

        function showSystemStatus() {
            currentSection = 'status';
            closeMobileMenu();
            stopRunningTasksAutoRefresh();

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget?.classList.add('active');

            document.getElementById('dataPanel').style.display = 'none';
            document.getElementById('contentPanel').style.display = 'none';
            document.getElementById('runningTasksPanel').classList.remove('active');
            document.getElementById('taskPanel').classList.remove('active');
            document.getElementById('statusPanel').classList.add('active');

            loadSystemStatus();
        }

        async function loadTasks() {
            console.log('loadTasks called');
            const container = document.getElementById('taskListContainer');
            if (!container) {
                console.error('taskListContainer not found');
                return;
            }
            container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ä»»åŠ¡...</div>';

            try {
                // åŒæ—¶è·å–ä»»åŠ¡åˆ—è¡¨å’Œè¿è¡Œä¸­ä»»åŠ¡
                const [tasksResponse, runningResponse] = await Promise.all([
                    fetch('/api/scheduler/tasks'),
                    fetch('/api/task-monitor/running').catch(() => ({ json: () => ({ tasks: [] }) }))
                ]);

                const data = await tasksResponse.json();
                const runningData = await runningResponse.json();
                console.log('Tasks API response:', data);

                // è·å–è¿è¡Œä¸­ä»»åŠ¡çš„IDé›†åˆ
                const runningTaskIds = new Set((runningData.tasks || []).map(t => t.task_id));

                if (data.error) {
                    container.innerHTML = `<div class="task-empty"><p>âŒ ${data.error}</p></div>`;
                    return;
                }

                if (!data.tasks || data.tasks.length === 0) {
                    container.innerHTML = `
                        <div class="task-empty">
                            <p class="icon">ğŸ“‹</p>
                            <p>æš‚æ— ä»»åŠ¡é…ç½®</p>
                        </div>
                    `;
                    return;
                }

                window.tasksData = data.tasks;

                let html = '<div class="task-grid">';
                data.tasks.forEach(task => {
                    const scheduleText = getScheduleText(task.schedule);
                    const isRunning = runningTaskIds.has(task.id);

                    let statusClass, statusText;
                    if (isRunning) {
                        statusClass = 'running';
                        statusText = 'ğŸ”„ è¿è¡Œä¸­';
                    } else if (task.enabled) {
                        statusClass = 'running';
                        statusText = 'âœ… å·²å¯ç”¨';
                    } else {
                        statusClass = 'stopped';
                        statusText = 'â¸ï¸ å·²ç¦ç”¨';
                    }

                    const toggleText = task.enabled ? 'â¸ï¸ ç¦ç”¨' : 'â–¶ï¸ å¯ç”¨';
                    const toggleClass = task.enabled ? 'toggle' : 'run';

                    // è¿è¡Œä¸­çš„ä»»åŠ¡æ·»åŠ ç‰¹æ®Šæ ·å¼
                    const cardStyle = isRunning ? 'style="border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);"' : '';
                    const runningBadge = isRunning ? '<span style="color: var(--success); font-size: 0.8rem; margin-left: 8px;">â— æ­£åœ¨æ‰§è¡Œ</span>' : '';

                    html += `
                        <div class="task-card" ${cardStyle}>
                            <div class="task-card-header">
                                <div>
                                    <div class="task-title">${task.name}${runningBadge}</div>
                                    <div class="task-desc">${task.description || 'æš‚æ— æè¿°'}</div>
                                </div>
                                <span class="status-tag ${statusClass}">${statusText}</span>
                            </div>
                            <div class="task-meta">
                                <span class="task-schedule">${scheduleText}</span>
                                <div class="task-actions">
                                    <button class="btn-task run" onclick="runTask('${task.id}')" ${!task.enabled || isRunning ? 'disabled style="opacity:0.5"' : ''}>${isRunning ? 'ğŸ”„ æ‰§è¡Œä¸­' : 'â–¶ï¸ è¿è¡Œ'}</button>
                                    <button class="btn-task" onclick="editTask('${task.id}')">âœï¸ ç¼–è¾‘</button>
                                    <button class="btn-task ${toggleClass}" onclick="toggleTask('${task.id}')" ${isRunning ? 'disabled style="opacity:0.5"' : ''}>${toggleText}</button>
                                    <button class="btn-task" onclick="viewTaskLogs()">ğŸ“‹ æ—¥å¿—</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;
                console.log('Tasks loaded successfully');

            } catch (error) {
                console.error('Load tasks error:', error);
                container.innerHTML = `<div class="task-empty"><p>âŒ åŠ è½½å¤±è´¥: ${error.message}</p></div>`;
            }
        }

        function getScheduleText(schedule) {
            if (!schedule) return 'æœªé…ç½®';
            const type = schedule.type;
            if (type === 'daily') {
                return `ğŸ“… æ¯å¤© ${schedule.time || '00:00'}`;
            } else if (type === 'interval') {
                return `ğŸ”„ æ¯ ${schedule.minutes || 60} åˆ†é’Ÿ`;
            } else if (type === 'cron') {
                return `â° ${schedule.expression || ''}`;
            }
            return type || 'æœªé…ç½®';
        }

        async function loadSystemStatus() {
            const container = document.getElementById('servicesContainer');
            const lastUpdate = document.getElementById('statusLastUpdate');
            
            container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æœåŠ¡çŠ¶æ€...</div>';
            
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();

                if (data.services) {
                    container.innerHTML = data.services.map(service => `
                        <div class="service-card">
                            <div class="service-card-header">
                                <div>
                                    <div class="service-card-title">${service.name}</div>
                                    <div class="service-card-desc">${service.description}</div>
                                </div>
                                <div class="status-tags">
                                    <span class="status-tag ${service.running ? 'running' : 'stopped'}">
                                        ${service.running ? 'â— è¿è¡Œä¸­' : 'â— å·²åœæ­¢'}
                                    </span>
                                    <span class="status-tag ${service.enabled ? 'enabled' : 'disabled'}">
                                        ${service.enabled ? 'âœ“ å·²å¯ç”¨' : 'âœ— æœªå¯ç”¨'}
                                    </span>
                                </div>
                            </div>
                            <div class="service-actions">
                                <button class="btn-action" onclick="viewServiceLogs('${service.id}', '${service.name}')">ğŸ“‹ æŸ¥çœ‹æ—¥å¿—</button>
                                <button class="btn-action primary" onclick="restartService('${service.id}', '${service.name}')">ğŸ”„ é‡å¯æœåŠ¡</button>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('platformInfo').textContent = `å¹³å°: ${data.platform} | æ›´æ–°æ—¶é—´: ${data.timestamp}`;
                    lastUpdate.textContent = `ä¸Šæ¬¡æ›´æ–°: ${data.timestamp}`;
                }
            } catch (error) {
                container.innerHTML = `<div class="task-empty"><p>âŒ è·å–çŠ¶æ€å¤±è´¥: ${error.message}</p></div>`;
                lastUpdate.textContent = 'æ›´æ–°å¤±è´¥';
            }
        }

        async function viewServiceLogs(serviceId, serviceName) {
            currentLogService = serviceId;
            document.getElementById('logsModalTitle').textContent = `ğŸ“‹ ${serviceName} - æ—¥å¿—`;
            document.getElementById('logsModal').classList.add('active');
            await loadServiceLogs(serviceId);
        }

        async function loadServiceLogs(serviceId) {
            const logContent = document.getElementById('taskLogsContent');
            logContent.innerHTML = '<div class="log-empty">æ­£åœ¨åŠ è½½æ—¥å¿—...</div>';

            try {
                const response = await fetch(`/api/system/logs/${serviceId}?lines=100`);
                const data = await response.json();

                if (data.logs) {
                    const formattedLogs = formatLogs(data.logs);
                    logContent.innerHTML = formattedLogs;
                    logContent.scrollTop = 0;
                } else {
                    logContent.innerHTML = '<div class="log-empty">æš‚æ— æ—¥å¿—</div>';
                }
            } catch (error) {
                logContent.innerHTML = `<div class="log-empty" style="color: #ff4d4f;">åŠ è½½æ—¥å¿—å¤±è´¥: ${error.message}</div>`;
            }
        }

        function formatLogs(logs) {
            if (!logs) return '';
            
            return logs.split('\n').map(line => {
                let cssClass = 'log-line';
                const lowerLine = line.toLowerCase();

                if (lowerLine.includes('error') || lowerLine.includes('exception') || lowerLine.includes('failed')) {
                    cssClass += ' error';
                } else if (lowerLine.includes('warning') || lowerLine.includes('warn')) {
                    cssClass += ' warning';
                } else if (lowerLine.includes('success') || lowerLine.includes('completed') || lowerLine.includes('done')) {
                    cssClass += ' success';
                } else if (lowerLine.includes('info') || lowerLine.includes('[i]')) {
                    cssClass += ' info';
                }

                const escaped = line
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                return `<div class="${cssClass}">${escaped}</div>`;
            }).join('');
        }

        function runTask(taskId) {
            console.log('runTask called with taskId:', taskId);
            currentTaskId = taskId;
            currentPasswordAction = 'run';
            document.getElementById('passwordModalTitle').textContent = 'â–¶ï¸ è¿è¡Œä»»åŠ¡';
            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('passwordInput').focus();
        }

        function toggleTask(taskId) {
            console.log('toggleTask called with taskId:', taskId);
            currentTaskId = taskId;
            currentPasswordAction = 'toggle';
            
            const task = window.tasksData?.find(t => t.id === taskId);
            const isDisable = task && task.enabled;
            console.log('Task current state:', task?.enabled, 'isDisable:', isDisable);
            
            document.getElementById('passwordModalTitle').textContent = `${isDisable ? 'â¸ï¸' : 'â–¶ï¸'} ${isDisable ? 'ç¦ç”¨' : 'å¯ç”¨'}ä»»åŠ¡`;
            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('passwordInput').focus();
        }

        function editTask(taskId) {
            currentTaskId = taskId;
            
            const task = window.tasksData?.find(t => t.id === taskId);
            if (!task) {
                alert('æ— æ³•æ‰¾åˆ°ä»»åŠ¡ä¿¡æ¯');
                return;
            }
            
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskName').value = task.name || '';
            document.getElementById('editTaskDesc').value = task.description || '';
            document.getElementById('editTaskCommand').value = task.command || '';
            document.getElementById('editTaskTimeout').value = task.timeout || 300;
            
            const scheduleType = task.schedule?.type || 'daily';
            document.getElementById('editScheduleType').value = scheduleType;
            
            if (scheduleType === 'daily') {
                document.getElementById('scheduleTimeGroup').style.display = 'block';
                document.getElementById('scheduleMinutesGroup').style.display = 'none';
                document.getElementById('editScheduleTime').value = task.schedule?.time || '00:00';
            } else if (scheduleType === 'interval') {
                document.getElementById('scheduleTimeGroup').style.display = 'none';
                document.getElementById('scheduleMinutesGroup').style.display = 'block';
                document.getElementById('editScheduleMinutes').value = task.schedule?.minutes || 60;
            } else {
                document.getElementById('scheduleTimeGroup').style.display = 'none';
                document.getElementById('scheduleMinutesGroup').style.display = 'none';
            }
            
            document.getElementById('editModal').classList.add('active');
        }

        function viewTaskLogs() {
            document.getElementById('logsModalTitle').textContent = 'ğŸ“‹ è°ƒåº¦å™¨æ—¥å¿—';
            document.getElementById('logsModal').classList.add('active');
            loadSchedulerLogs();
        }

        async function loadSchedulerLogs() {
            const container = document.getElementById('taskLogsContent');
            container.innerHTML = '<div class="log-empty">æ­£åœ¨åŠ è½½æ—¥å¿—...</div>';
            
            try {
                const response = await fetch('/api/scheduler/logs?lines=100');
                const data = await response.json();
                
                if (data.logs) {
                    const formattedLogs = formatLogs(data.logs);
                    container.innerHTML = formattedLogs;
                    container.scrollTop = 0;
                } else {
                    container.innerHTML = '<div class="log-empty">æš‚æ— æ—¥å¿—</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="log-empty" style="color: #ff4d4f;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
            document.getElementById('passwordInput').value = '';
            currentPasswordAction = null;
            currentTaskId = null;
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentTaskId = null;
        }

        function closeLogsModal() {
            document.getElementById('logsModal').classList.remove('active');
        }

        function togglePasswordVisibility() {
            const input = document.getElementById('passwordInput');
            const icon = document.getElementById('passwordToggleIcon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.textContent = 'ğŸ‘ï¸';
            }
        }

        async function confirmPasswordAction() {
            const password = document.getElementById('passwordInput').value;
            console.log('confirmPasswordAction called, action:', currentPasswordAction, 'taskId:', currentTaskId);
            
            if (!password) {
                alert('è¯·è¾“å…¥å¯†ç ');
                return;
            }
            
            // ä¿å­˜å½“å‰æ“ä½œç±»å‹ï¼Œå› ä¸º closePasswordModal ä¼šé‡ç½®å®ƒ
            const action = currentPasswordAction;
            const taskId = currentTaskId;
            
            closePasswordModal();
            
            if (action === 'run') {
                await executeRunTask(taskId, password);
            } else if (action === 'toggle') {
                await executeToggleTask(taskId, password);
            } else if (action === 'restart') {
                await executeRestartService(taskId, password);
            } else {
                console.error('Unknown action:', action);
            }
        }

        async function executeRunTask(taskId, password) {
            console.log('executeRunTask called with taskId:', taskId);
            try {
                const response = await fetch(`/api/scheduler/run/${taskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                const data = await response.json();
                console.log('Run response:', data);
                
                if (data.success) {
                    alert(`âœ… ${data.message}`);
                } else {
                    alert(`âŒ ${data.message}`);
                }
            } catch (error) {
                console.error('Run error:', error);
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        async function executeToggleTask(taskId, password) {
            console.log('executeToggleTask called with taskId:', taskId);
            try {
                const response = await fetch(`/api/scheduler/toggle/${taskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                const data = await response.json();
                console.log('Toggle response:', data);
                
                if (data.success) {
                    alert(`âœ… ${data.message}`);
                    await loadTasks();
                } else {
                    alert(`âŒ ${data.message}`);
                }
            } catch (error) {
                console.error('Toggle error:', error);
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        async function saveTaskConfig() {
            const taskId = document.getElementById('editTaskId').value;
            const taskConfig = {
                name: document.getElementById('editTaskName').value,
                description: document.getElementById('editTaskDesc').value,
                command: document.getElementById('editTaskCommand').value,
                timeout: parseInt(document.getElementById('editTaskTimeout').value) || 300,
                schedule: {
                    type: document.getElementById('editScheduleType').value
                }
            };
            
            if (taskConfig.schedule.type === 'daily') {
                taskConfig.schedule.time = document.getElementById('editScheduleTime').value || '00:00';
            } else if (taskConfig.schedule.type === 'interval') {
                taskConfig.schedule.minutes = parseInt(document.getElementById('editScheduleMinutes').value) || 60;
            } else if (taskConfig.schedule.type === 'cron') {
                taskConfig.schedule.expression = '';
            }
            
            const password = prompt('è¯·è¾“å…¥å¯†ç ä»¥ä¿å­˜é…ç½®:');
            if (!password) return;
            
            try {
                const response = await fetch('/api/scheduler/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: password,
                        task_id: taskId,
                        config: taskConfig
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… ä»»åŠ¡é…ç½®å·²æ›´æ–°');
                    closeEditModal();
                    loadTasks();
                } else {
                    alert(`âŒ ${data.message}`);
                }
            } catch (error) {
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        async function restartService(serviceId, serviceName) {
            currentTaskId = serviceId;
            
            if (!confirm(`âš ï¸ ç¡®å®šè¦é‡å¯ ${serviceName} æœåŠ¡å—?\n\né‡å¯æœŸé—´æœåŠ¡å°†æš‚æ—¶ä¸å¯ç”¨ã€‚`)) {
                return;
            }
            
            currentPasswordAction = 'restart';
            document.getElementById('passwordModalTitle').textContent = `ğŸ”„ é‡å¯ ${serviceName}`;
            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('passwordInput').focus();
        }

        async function executeRestartService(serviceId, password) {
            try {
                const response = await fetch(`/api/system/restart/${serviceId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`âœ… æœåŠ¡é‡å¯æˆåŠŸï¼`);
                    loadSystemStatus();
                } else {
                    alert(`âŒ é‡å¯å¤±è´¥: ${data.message}`);
                }
            } catch (error) {
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePasswordModal();
                closeEditModal();
                closeLogsModal();
            }
        });

        document.getElementById('passwordModal').addEventListener('click', function(e) {
            if (e.target === this) closePasswordModal();
        });

        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });

        document.getElementById('logsModal').addEventListener('click', function(e) {
            if (e.target === this) closeLogsModal();
        });

        document.getElementById('editScheduleType').addEventListener('change', function() {
            const type = this.value;
            document.getElementById('scheduleTimeGroup').style.display = type === 'daily' ? 'block' : 'none';
            document.getElementById('scheduleMinutesGroup').style.display = type === 'interval' ? 'block' : 'none';
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¿è¡Œä¸­ä»»åŠ¡ï¼ˆæ›´æ–°ä¾§è¾¹æ æŒ‡ç¤ºå™¨ï¼‰
        async function checkRunningTasksOnLoad() {
            try {
                const response = await fetch('/api/task-monitor/summary');
                const data = await response.json();
                const indicator = document.getElementById('runningTaskIndicator');
                
                if (data.running_count > 0) {
                    indicator.style.display = 'inline-block';
                } else {
                    indicator.style.display = 'none';
                }
            } catch (error) {
                console.log('æ— æ³•è·å–ä»»åŠ¡ç›‘æ§æ‘˜è¦:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            checkRunningTasksOnLoad();
        });
    </script>
</body>
</html>
